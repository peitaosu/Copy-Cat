<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Couple Splice</title>
</head>

<body>
    <div>
        <video id="view" style="width:100%;height:auto;"></video>
        <video id="full" style="width:3024px;height:4032px;display:none;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
    <div>
        <label for="source">Source: </label><select id="source"></select>
    </div>
    <div>
        <button id="take">Take</button>
        <button id="down">Down</button>
    </div>
    <div>
        <img src="" id="photo" />
    </div>
    <div>
        <p id="debug"></p>
    </div>

    <script>
        !(function () {
            let view = document.getElementById('view');
            let full = document.getElementById('full');
            let take = document.getElementById('take');
            let canvas = document.getElementById('canvas');
            let photo = document.getElementById('photo');
            let videoSelect = document.querySelector('select#source');
            videoSelect.onchange = getStream;
            let videoPlaying = false;
            let photoCaptured = false;

            navigator.mediaDevices.enumerateDevices()
                .then(gotDevices).then(getStream)

            function gotDevices(deviceInfos) {
                for (var i = 0; i !== deviceInfos.length; ++i) {
                    var deviceInfo = deviceInfos[i];
                    var option = document.createElement('option');
                    option.value = deviceInfo.deviceId;
                    if (deviceInfo.kind === 'videoinput') {
                        option.text = deviceInfo.label || 'camera ' +
                            (videoSelect.length + 1);
                        videoSelect.appendChild(option);
                    }
                }
            }

            function getStream() {
                if (window.stream) {
                    window.stream.getTracks().forEach(function (track) {
                        track.stop();
                    });
                }

                var constraints = {
                    audio: false,
                    video: {
                        deviceId: { exact: videoSelect.value },
                        width: { ideal: 4096 },
                        height: { ideal: 4096 } 
                    }
                };

                navigator.mediaDevices.getUserMedia(constraints).
                    then(gotStream);
            }

            function gotStream(stream) {
                window.stream = stream;
                view.srcObject = stream;
                view.onloadedmetadata = function (e) {
                    view.play();
                    videoPlaying = true;
                };
                full.srcObject = stream;
                full.onloadedmetadata = function (e) {
                    full.play();
                };
            }

            take.addEventListener('click', function () {
                if (videoPlaying) {
                    canvas.width = full.videoWidth;
                    canvas.height = full.videoHeight;
                    canvas.getContext('2d').drawImage(full, 0, 0);
                    let data = canvas.toDataURL('image/png');
                    photo.setAttribute('src', data);
                    photoCaptured = true;
                }
            }, false);

            down.addEventListener('click', function () {
                if (photoCaptured) {
                    let link = document.createElement("a");
                    link.href = photo.getAttribute('src');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }, false);
        })();
    </script>
</body>

</html>